# ูฺฉุฑูุณุฑูุณ Query Service
ุงู ูฺฉุฑูุณุฑูุณ ฺฉ API ุณุจฺฉุ ุณุฑุนุ ุงูู ู ูุงุจูโุชูุณุนู ุจุฑุง ุงุฌุฑุง ฺฉูุฆุฑโูุง ุงุฒ ูพุด ุชุนุฑูโุดุฏู ุฏุฑ PostgreSQL ุงุณุช.
ุฏุฑ ุงู ุณุฑูุณุ ฺฉูุงูุชโูุง ุจุฏูู ุงุฑุณุงู SQL ุฎุงู ู ุชููุง ุจุง ุงุณุชูุงุฏู ุงุฒ ูุงู ฺฉูุฆุฑ ู ูพุงุฑุงูุชุฑูุง ูุงุฒูุ ุฏุงุฏู ุฏุฑุงูุช ูโฺฉููุฏ.

---

# ๐ ูฺฺฏโูุง

- **ุงุฌุฑุง ฺฉูุฆุฑโูุง ุงูู (Prepared Queries)**
- **ุฎุฑูุฌโูุง ูุฎุชูู ุจุฑ ุงุณุงุณ Accept Header**
  - `application/json` โ JSON (ูพุดโูุฑุถ)
  - `text/csv` โ ูุงู CSV ุงุณุชุงูุฏุงุฑุฏ
- **ุนุฏู ุงุฌุฑุง SQL ุฎุงู ู ุฌููฺฏุฑ ฺฉุงูู ุงุฒ SQL Injection**
- **ุณุงุฎุชุงุฑ ูุงฺููุงุฑ (Controller / Service / Query Registry / Middleware)**
- **ูพุดุชุจุงู ุงุฒ Redis ุจุฑุง Cache (ุงุฎุชุงุฑ)**
- **ูุงุจูโุงุณุชูุงุฏู ุจุฑุง ุงููุงุน ุณุณุชูโูุง ฺฉูุงูุช (Django, React, Excel, BI Tools)**
- **ููุงุณุจ ุณุงูุงููโูุง ูพุฑูุดุงุฑ ู ุณุงุฒูุงู**

---

# ๐ ุณุงุฎุชุงุฑ ูพุฑูฺู

```

src/
โ
โโโ controllers/
โ     โโโ queryController.js        # ฺฉูุชุฑู ูพุฑุฏุงุฒุด ฺฉูุฆุฑ ู ุณุงุฎุช ุฎุฑูุฌ
โ
โโโ services/
โ     โโโ dbService.js             # ุงุฌุฑุง Prepared Statement ุจุง ูพุงุฑุงูุชุฑูุง
โ     โโโ redis.js                 # ุงุชุตุงู ุจู Redis (ุงุฎุชุงุฑ)
โ
โโโ middlewares/
โ     โโโ logger.js                # ูุงฺฏ ุฏุฑุฎูุงุณุชโูุง
โ     โโโ errorHandler.js          # ูุฏุฑุช ุฎุทุงูุง ุณุฑุงุณุฑ
โ
โโโ queries/
โ     โโโ preparedQueries.js       # ูุณุช ฺฉูุฆุฑโูุง ูุฌุงุฒ
โ
โโโ routes/
โ     โโโ queryRoutes.js           # ูุณุฑูุง API
โ
โโโ db.js                          # ุงุชุตุงู ุจู PostgreSQL
โโโ server.js                      # ุฑุงูโุงูุฏุงุฒ ุณุฑูุฑ Express
โโโ redis.js                      # ุจุฑุง cache
```

---

# ๐ง ูุนูุงุฑ ฺฉู

ูฺฉุฑูุณุฑูุณ ุจุฑ ูพุงู ูุนูุงุฑ ุฒุฑ ุทุฑุงุญ ุดุฏู ุงุณุช:

```

Client โ Routes โ Controller โ Service โ PostgreSQL
โ
Redis Cache (ุงุฎุชุงุฑ)

````

- **Routes:** ุฏุฑุงูุช URL ูุงููุฏ: `/query/:queryName`
- **Controller:** ุจุฑุฑุณ ูุฑูุฏ + ุงูุชุฎุงุจ JSON ุง CSV ุจุฑ ุงุณุงุณ Accept
- **Service:** ุงุฌุฑุง Prepared Query
- **Queries Registry:** ุชุนุฑู ุชูุงู ฺฉูุฆุฑโูุง ูุฌุงุฒ
- **Redis:** ุฐุฎุฑูโ ูุชุงุฌ ฺฉูุฆุฑโูุง (ุจุฑุง ุงูุฒุงุด ุณุฑุนุช)
- **Middleware:** ูุงฺฏ + ูุฏุฑุช ุฎุทุง

---

# โ๏ธ ูุตุจ ู ุงุฌุฑุง

### 1) ูุตุจ ูพฺฉุฌโูุง
```bash
mkdir microservice && cd microservice
npm init -y
npm install express pg dotenv redis morgan
````

### 2) ุงุฌุงุฏ ูุงู ูุญุท `.env`

```env
PG_HOST=localhost
PG_PORT=5432
PG_USER=postgres
PG_PASSWORD=yourpass
PG_DATABASE=mydb
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
PG_POOL_MAX=30
PG_IDLE_TIMEOUT=30000
PG_CONNECTION_TIMEOUT=2000
```

### 3) ุงุฌุฑุง ุณุฑูุณ

```bash
node src/server.js
```

ูพูุฑุช ูพุดโูุฑุถ: **3000**

---

# ๐งฉ ูุญูู ุงุณุชูุงุฏู ุงุฒ API

### ๐น ูุณุฑ ุงุตู:

```
POST /query/:queryName
```

ูุซุงู:

```
POST /query/selEquFilterGrid
```

---

### ๐น ูพุงุฑุงูุชุฑูุง (ููุท ุฏุฑ Body)

```json
{
  "type_id": 10510,
  "equ_id": 6
}
```

---

### ๐น ุชุนู ููุน ุฎุฑูุฌ ุจุง Header

#### โ ุฎุฑูุฌ JSON

```
Accept: application/json
```

#### โ ุฎุฑูุฌ CSV

```
Accept: text/csv
```

---

# ๐ฆ ููููู ุฎุฑูุฌ JSON

```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "code": "GR01",
      "title": "Group A",
      "is_active": true
    }
  ]
}
```

---

# ๐จ ููููู ุฎุฑูุฌ CSV

```
id,code,title,is_active
1,GR01,Group A,true
2,GR02,Group B,true
```

ูุงุจู ุงุณุชูุงุฏู ุฏุฑ:

* Excel
* Google Sheets
* Power BI
* DataTables
* AG-Grid
* ูุฑ ุงุจุฒุงุฑ BI ู ฺฏุฒุงุฑุดโฺฏุฑ

---

# ๐ ุงูุฒูุฏู ฺฉ ฺฉูุฆุฑ ุฌุฏุฏ

ุฏุฑ ูุงู ุฒุฑ:

```
src/queries/preparedQueries.js
```

ูุซุงู ุงุถุงููโฺฉุฑุฏู ฺฉูุฆุฑ:

```js
myQuery: {
  sql: "SELECT * FROM my_table WHERE id = $1",
  params: ["id"]
}
```

ูุฑุงุฎูุงู:

```
POST /query/myQuery
```

Body:

```json
{
  "id": 5
}
```

---

# ๐ ุงููุช

* ุนุฏู ุงุฌุฑุง SQL ุฎุงู
* ุงุฌุฑุง ููุท ฺฉูุฆุฑโูุง ุงุฒ ูพุด ุชุนุฑูโุดุฏู
* ุฌููฺฏุฑ ฺฉุงูู ุงุฒ SQL Injection
* ูุงุณุท ุงูู ุจู ุฏุชุงุจุณ ู ฺฉูุงูุช

---

# ๐งช ููููู cURL

## JSON

```bash
curl -X POST http://localhost:3000/query/selEquFilterGrid \
  -H "Accept: application/json" \
  -H "Content-Type: application/json" \
  -d '{"type_id":10510, "equ_id":6}'
```

## CSV

```bash
curl -X POST http://localhost:3000/query/selEquFilterGrid \
  -H "Accept: text/csv" \
  -H "Content-Type: application/json" \
  -d '{"type_id":10510, "equ_id":6}'
```

---

# ๐งฑ ุชฺฉููููฺโูุง ุงุณุชูุงุฏูโุดุฏู

* Node.js
* Express
* PostgreSQL
* Redis (ุงุฎุชุงุฑ)
* Prepared Statements
* Content Negotiation (Accept Header)
* Middlewareโูุง ุงุณุชุงูุฏุงุฑุฏ

---

# ๐ฏ ูุฒุงุง ุงุตู ุณุณุชู

* **ุจุณุงุฑ ุงูู** ุจู ุฏูู ุญุฐู ฺฉุงูู SQL ุฎุงู
* **ุณุฑุน ู ุณุจฺฉ**
* **ูุงุจู ุงุชุตุงู ุจู ูุฑ ุณุณุชู ุฎุงุฑุฌ (Django, React, ERP, ฺฏุฒุงุฑุดุงุช)**
* **ูุงุจู ฺฉุด ุดุฏู** ุจุฑุง ุณุฑุนุช ุจุณุงุฑ ุจุงูุง
* **ุฎุฑูุฌ ุณุงุฒฺฏุงุฑ ุจุง ุงุจุฒุงุฑูุง ุชุญูู**
* **ุชูุณุนู ุขุณุงู ุจุง ุณุงุฎุชุงุฑ ูุงฺููุงุฑ**

---

# ๐ฎ ฺฏุงูโูุง ุจุนุฏ ุชูุณุนู (ูพุดููุงุฏูุง ุงุฑุชูุง)

* โ ุงูุฒูุฏู **Rate Limiting** ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุญููุงุช
* โ ุงูุฒูุฏู **JWT Authentication**
* โ ูพุดุชุจุงู ุงุฒ **GraphQL Wrapper**
* โ ุงุถุงููโฺฉุฑุฏู **Monitoring (Prometheus + Grafana)**
* โ ุงูุฒูุฏู **Batch Query / Bulk Execute**
* โ ูพุดุชุจุงู ุงุฒ **Output: XLSX (Excel)**
* โ ุงุถุงููโฺฉุฑุฏู **Versioning (v1, v2, โฆ)**
* โ ุงุถุงููโฺฉุฑุฏู **Pagination ุฏุงุฎู ุจุฑุง ฺฉูุฆุฑโูุง ุจุฒุฑฺฏ**
* โ ุงุถุงููโฺฉุฑุฏู **Cache Rule per Query** ุฏุฑ Redis

---

# ๐ค ูฺฏูุฏุงุฑูุฏู

ุงู ูฺฉุฑูุณุฑูุณ ุจุฑุง ุงุณุชูุงุฏู ุฏุฑ ูพุฑูฺูโูุง ุณุงุฒูุงู ู ุณุงูุงููโูุง ูพุฑุชุฑุงูฺฉ ุทุฑุงุญ ุดุฏู ู ุงูุนุทุงู ฺฉุงูู ุจุฑุง ุชูุณุนู ุจุดุชุฑ ุฑุง ุฏุงุฑุฏ.

```


